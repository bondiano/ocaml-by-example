# Инструменты OCaml: Dune, opam, ocamlformat

Справочник по инструментам экосистемы OCaml: Dune, ocamlformat, предупреждения компилятора, LSP, opam, odoc.

## Содержание

- [Dune — система сборки](#dune--система-сборки)
  - [Структура проекта](#структура-проекта)
  - [Правила и действия](#правила-и-действия)
  - [Встраивание ресурсов](#встраивание-ресурсов)
  - [Платформозависимый код](#платформозависимый-код)
  - [Флаги и профили](#флаги-и-профили)
  - [Зависимости в тестах](#зависимости-в-тестах)
- [ocamlformat — форматирование](#ocamlformat--форматирование)
  - [Настройка](#настройка)
  - [Использование](#использование)
  - [Интеграция с редактором](#интеграция-с-редактором)
- [Предупреждения компилятора](#предупреждения-компилятора)
  - [Полезные предупреждения](#полезные-предупреждения)
  - [warn-error в dune](#warn-error-в-dune)
  - [Атрибуты @warning](#атрибуты-warning)
- [ocaml-lsp-server](#ocaml-lsp-server)
  - [VS Code](#vs-code)
  - [Neovim](#neovim)
  - [Watch mode](#watch-mode)
- [opam — управление пакетами](#opam--управление-пакетами)
  - [Switch](#switch)
  - [Установка и поиск](#установка-и-поиск)
  - [Pin — локальные пакеты](#pin--локальные-пакеты)
- [odoc — документация](#odoc--документация)

---

## Dune — система сборки

### Структура проекта

**`dune-project`** — корневой файл проекта. Он обязателен и определяет версию языка конфигурации:

```dune
(lang dune 3.0)
(name my_project)
```

Dune поддерживает три основных компонента:

**`library`** — библиотека, набор модулей для переиспользования:

```dune
(library
 (name my_lib)
 (public_name my-project.lib)
 (libraries str unix))
```

**`executable`** — исполняемый файл:

```dune
(executable
 (name main)
 (public_name my-tool)
 (libraries my_lib cmdliner))
```

**`test`** — тесты:

```dune
(test
 (name test_main)
 (libraries my_lib alcotest))
```

**`name` vs `public_name`:** `name` — внутреннее имя для ссылок внутри проекта, `public_name` — имя для публикации в opam. Без `public_name` компонент остаётся приватным.

**Конвенции public names:**

- Точки обозначают поддиректорию внутри пакета: `lwt.unix` — библиотека `unix` внутри пакета `lwt`.
- Дефисы обозначают отдельный пакет: `cohttp-eio` — самостоятельный пакет, зависящий от `cohttp`.

### Правила и действия

Dune позволяет определять произвольные правила сборки через `rule`. Каждое правило описывает, как из входных файлов (`deps`) получить выходные (`target`):

```dune
(rule
 (target a.out)
 (deps main.ml)
 (action (run ocamlopt main.ml)))
```

Действие `action` может содержать: `run`, `echo`, `cat`, `copy`, `with-stdout-to` и другие.

### Встраивание ресурсов

Dune позволяет встраивать содержимое файлов в OCaml-код на этапе сборки. Это полезно для CSS, SQL-запросов, шаблонов:

```dune
(rule
 (with-stdout-to css.ml
  (progn
   (echo "let css = {|")
   (cat resources/site.css)
   (echo "|}"))))
```

Результат — файл `css.ml` с содержимым:

```ocaml
let css = {|
/* содержимое resources/site.css */
body { margin: 0; }
|}
```

`{| ... |}` — синтаксис quoted string в OCaml: произвольный текст без экранирования.

### Платформозависимый код

Для кросс-платформенных библиотек Dune поддерживает условный выбор реализации через `select`:

```dune
(library
 (public_name crypt)
 (libraries
  (select ffi.ml from
   (if_is_linux_or_freebsd -> ffi.posix.extended.ml))))
```

Конструкция `select ... from` выбирает файл реализации в зависимости от платформы или доступных библиотек.

### Флаги и профили

**Авто-open модуля** через `env`:

```dune
(env
 (_
  (flags (:standard -open Base))))
```

Флаг `-open Base` автоматически открывает модуль `Base` во всех файлах. Часто используется с альтернативными стандартными библиотеками (Base, Core).

**Release-сборка:**

```text
$ dune build --profile release
```

Профиль `release` включает оптимизации и отключает отладочную информацию.

**Watch mode** — перекомпиляция при изменении файлов:

```text
$ dune build @check -w
```

Полезно для ускорения работы LSP-сервера — ошибки обновляются в реальном времени.

### Зависимости в тестах

Если тесты используют внешние файлы (данные, фикстуры), их нужно явно объявить в `deps`:

```dune
(test
 (name test_demo)
 (deps data.test.txt))
```

Без `deps` Dune не скопирует файл в директорию сборки. Путь в коде — относительный:

```ocaml
let data = In_channel.with_open_text "data.test.txt" In_channel.input_all
```

---

## ocamlformat — форматирование

[ocamlformat](https://github.com/ocaml-ppx/ocamlformat) — автоформаттер для OCaml. Устраняет споры о форматировании и обеспечивает единообразный стиль.

```admonish tip title="Для Python-разработчиков"
`ocamlformat` — это аналог `black`. Как и `black`, он намеренно предоставляет мало настроек.
```

### Настройка

Создайте файл `.ocamlformat` в корне проекта:

```text
version = 0.27.0
```

Минимально необходим только номер версии — это гарантирует одинаковые правила у всех участников проекта. Дополнительные настройки:

```text
version = 0.27.0
margin = 90
```

```admonish warning title="Важно"
Файл `.ocamlformat` обязателен. Без него ocamlformat откажется работать.
```

### Использование

Проверить форматирование и показать diff:

```text
$ dune fmt
```

Применить изменения:

```text
$ dune promote
```

Или в один шаг:

```text
$ dune fmt 2>/dev/null; dune promote
```

### Интеграция с редактором

Если установлен `ocaml-lsp-server`, форматирование работает через LSP. В VS Code срабатывает при сохранении файла (если включено `Format on Save`).

---

## Предупреждения компилятора

В OCaml нет отдельного линтера. **Компилятор выполняет роль линтера** через систему предупреждений (warnings).

### Полезные предупреждения

| Номер | Описание |
|-------|----------|
| 8 | Неполное сопоставление с образцом |
| 11 | Неиспользуемая привязка match |
| 26 | Неиспользуемый модуль |
| 27 | Неиспользуемая переменная |
| 32 | Неиспользуемое значение |
| 39 | Неиспользуемая декларация в .mli |

### warn-error в dune

Чтобы превратить предупреждения в ошибки компиляции (полезно в CI):

```dune
(env
 (dev
  (flags (:standard -warn-error -a+8+26+27+32))))
```

`-a` отключает все warn-error, `+8+26+27+32` включает конкретные предупреждения как ошибки.

### Атрибуты @warning

Точечное управление предупреждениями:

```ocaml
(* Подавить предупреждение о неиспользуемой переменной *)
let _unused = 42

(* Или через атрибут *)
let[@warning "-32"] helper x = x + 1
```

Конвенция: неиспользуемые привязки именуются с `_` — это подавляет предупреждение 27.

---

## ocaml-lsp-server

[ocaml-lsp-server](https://github.com/ocaml/ocaml-lsp) обеспечивает:

- **Автодополнение** — подсказки имён модулей, функций, типов.
- **Подсказки типов** — при наведении на выражение показывается его тип.
- **Переход к определению** — jump-to-definition для любого идентификатора.
- **Поиск ссылок** — все места использования функции.
- **Форматирование** — через ocamlformat.
- **Диагностика** — ошибки компиляции в реальном времени.

### VS Code

1. Установите расширение [OCaml Platform](https://marketplace.visualstudio.com/items?itemName=ocamllabs.ocaml-platform).
2. Откройте директорию с `dune-project` — не корень монорепозитория.
3. Расширение автоматически найдёт `ocamllsp`.

Горячие клавиши:

| Действие | macOS | Linux/Windows |
|----------|-------|---------------|
| Перейти к определению | `Cmd+Click` | `Ctrl+Click` |
| Показать тип | `Cmd+K, Cmd+I` | `Ctrl+K, Ctrl+I` |
| Найти все ссылки | `Shift+F12` | `Shift+F12` |
| Переименовать | `F2` | `F2` |

### Neovim

```lua
require('lspconfig').ocamllsp.setup {}
```

Убедитесь, что `ocamllsp` доступен в `$PATH` (через `eval $(opam env)`).

### Watch mode

Для ускорения обратной связи запустите Dune в watch-режиме в отдельном терминале:

```text
$ dune build @check -w
```

Это обновляет кэш сборки в реальном времени — LSP будет видеть свежие ошибки без полной пересборки.

---

## opam — управление пакетами

### Switch

Каждый switch содержит свою версию компилятора и набор пакетов — аналог `venv` в Python или `nvm` в Node.js:

```text
$ opam switch list
#   switch    compiler    description
→   5.4.0     ocaml.5.4.0 5.4.0

$ opam switch create my-project 5.4.0
$ eval $(opam env)
```

### Установка и поиск

```text
$ opam install dream yojson              # установить пакеты
$ opam list --installed                  # показать установленные
$ opam search json                       # найти пакеты по ключевому слову
$ opam info yojson                       # подробная информация о пакете
```

### Pin — локальные пакеты

Для разработки с локальной версией библиотеки:

```text
$ opam pin add my-lib ./path/to/lib      # привязать к локальному пути
$ opam pin remove my-lib                 # убрать привязку
```

Pin позволяет работать с форками или ещё не опубликованными версиями.

---

## odoc — документация

[odoc](https://ocaml.github.io/odoc/) генерирует HTML-документацию из комментариев в коде:

```ocaml
(** [greet name] возвращает приветствие для [name].

    Пример:
    {[
      greet "OCaml" = "Привет, OCaml!"
    ]}
*)
val greet : string -> string
```

Генерация:

```text
$ opam install odoc
$ dune build @doc
$ open _build/default/_doc/_html/index.html
```

Документация извлекается из `.mli`-файлов (или `.ml`, если `.mli` отсутствует). Формат — **odoc markup**, похожий на Javadoc.
